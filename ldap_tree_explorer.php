<?php
// LDAP Ê®πÁãÄÁµêÊßãÂÆåÊï¥Êé¢Á¥¢Â∑•ÂÖ∑
session_start();

$ldapConfig = require __DIR__ . '/config/ldap.php';

function connectLDAP($ldapConfig) {
    $server = $ldapConfig['use_ssl'] 
        ? "ldaps://{$ldapConfig['server']}:{$ldapConfig['port']}"
        : "ldap://{$ldapConfig['server']}:{$ldapConfig['port']}";
        
    $connection = ldap_connect($server);
    
    if (!$connection) {
        return false;
    }
    
    ldap_set_option($connection, LDAP_OPT_PROTOCOL_VERSION, 3);
    ldap_set_option($connection, LDAP_OPT_REFERRALS, 0);
    ldap_set_option($connection, LDAP_OPT_NETWORK_TIMEOUT, $ldapConfig['timeout']);
    
    if ($ldapConfig['use_tls']) {
        if (!ldap_start_tls($connection)) {
            ldap_unbind($connection);
            return false;
        }
    }
    
    if (!ldap_bind($connection, $ldapConfig['admin_username'], $ldapConfig['admin_password'])) {
        ldap_unbind($connection);
        return false;
    }
    
    return $connection;
}

function exploreLDAPTree($connection, $baseDN, $filter = '(objectClass=*)', $scope = 'sub') {
    $attributes = ['dn', 'objectClass', 'uid', 'cn', 'sAMAccountName', 'userPrincipalName', 
                   'mail', 'description', 'memberOf', 'member', 'department', 'title',
                   'telephoneNumber', 'createTimestamp', 'modifyTimestamp', 'userAccountControl'];
    
    try {
        if ($scope === 'one') {
            $search = ldap_list($connection, $baseDN, $filter, $attributes);
        } else {
            $search = ldap_search($connection, $baseDN, $filter, $attributes);
        }
        
        if (!$search) {
            return ['success' => false, 'message' => 'LDAPÊêúÂ∞ãÂ§±Êïó: ' . ldap_error($connection)];
        }
        
        $entries = ldap_get_entries($connection, $search);
        $results = [];
        
        for ($i = 0; $i < $entries['count']; $i++) {
            $entry = $entries[$i];
            $item = [
                'dn' => $entry['dn'],
                'objectClass' => isset($entry['objectclass']) ? $entry['objectclass'] : [],
                'uid' => isset($entry['uid'][0]) ? $entry['uid'][0] : '',
                'cn' => isset($entry['cn'][0]) ? $entry['cn'][0] : '',
                'sAMAccountName' => isset($entry['samaccountname'][0]) ? $entry['samaccountname'][0] : '',
                'userPrincipalName' => isset($entry['userprincipalname'][0]) ? $entry['userprincipalname'][0] : '',
                'mail' => isset($entry['mail'][0]) ? $entry['mail'][0] : '',
                'description' => isset($entry['description'][0]) ? $entry['description'][0] : '',
                'department' => isset($entry['department'][0]) ? $entry['department'][0] : '',
                'title' => isset($entry['title'][0]) ? $entry['title'][0] : '',
                'phone' => isset($entry['telephonenumber'][0]) ? $entry['telephonenumber'][0] : '',
                'created' => isset($entry['createtimestamp'][0]) ? $entry['createtimestamp'][0] : '',
                'modified' => isset($entry['modifytimestamp'][0]) ? $entry['modifytimestamp'][0] : '',
                'userAccountControl' => isset($entry['useraccountcontrol'][0]) ? $entry['useraccountcontrol'][0] : '',
                'memberOf' => isset($entry['memberof']) ? $entry['memberof'] : [],
                'member' => isset($entry['member']) ? $entry['member'] : []
            ];
            $results[] = $item;
        }
        
        return ['success' => true, 'results' => $results, 'count' => $entries['count']];
        
    } catch (Exception $e) {
        return ['success' => false, 'message' => 'ÈåØË™§: ' . $e->getMessage()];
    }
}

// Âª∫Á´ãLDAPÈÄ£Êé•
$connection = connectLDAP($ldapConfig);
$connectionStatus = $connection ? '‚úÖ ÈÄ£Êé•ÊàêÂäü' : '‚ùå ÈÄ£Êé•Â§±Êïó';

$explorations = [];

if ($connection) {
    // Â§öÁ®ÆÊé¢Á¥¢Á≠ñÁï•
    $strategies = [
        [
            'name' => 'üéØ Áõ¥Êé•ÊêúÂ∞ã ldapuser',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(|(uid=ldapuser)(cn=ldapuser)(sAMAccountName=ldapuser))',
            'description' => '‰ΩøÁî®Â§öÁ®ÆÂ±¨ÊÄßÁõ¥Êé•ÊêúÂ∞ã ldapuser'
        ],
        [
            'name' => 'üìã ÁÄèË¶ΩÊï¥ÂÄã cn=users ÁµÑÁπîÂñÆ‰Ωç',
            'base' => 'cn=users,dc=bookrep,dc=com,dc=tw',
            'filter' => '(objectClass=*)',
            'description' => 'ÂàóÂá∫ cn=users ‰∏≠ÁöÑÊâÄÊúâÊ¢ùÁõÆ'
        ],
        [
            'name' => 'üåê ÁÄèË¶ΩÊï¥ÂÄãÂüüÁöÑÈ†ÇÂ±§ÁµêÊßã',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(objectClass=*)',
            'scope' => 'one',
            'description' => 'Êü•ÁúãÂüüÁöÑÁõ¥Êé•Â≠êÁ¥öÁµêÊßã'
        ],
        [
            'name' => 'üë• ÊêúÂ∞ãÊâÄÊúâ inetOrgPerson',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(objectClass=inetOrgPerson)',
            'description' => 'Ê®ôÊ∫ñÁî®Êà∂Â∞çË±°È°ûÂûã'
        ],
        [
            'name' => 'üë§ ÊêúÂ∞ãÊâÄÊúâ person',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(objectClass=person)',
            'description' => 'Âü∫Êú¨‰∫∫Âì°Â∞çË±°È°ûÂûã'
        ],
        [
            'name' => 'üîß ÊêúÂ∞ãÊâÄÊúâ organizationalPerson',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(objectClass=organizationalPerson)',
            'description' => 'ÁµÑÁπî‰∫∫Âì°Â∞çË±°È°ûÂûã'
        ],
        [
            'name' => '‚öôÔ∏è ÊêúÂ∞ãÁ≥ªÁµ±ÂíåÊúçÂãôÂ∏≥Ëôü',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(|(objectClass=account)(objectClass=simpleSecurityObject)(description=*service*)(description=*system*))',
            'description' => 'Â∞àÈñÄÊêúÂ∞ãÊúçÂãôÂíåÁ≥ªÁµ±Â∏≥Ëôü'
        ],
        [
            'name' => 'üîç ÊêúÂ∞ãÊâÄÊúâÂåÖÂê´ ldap ÁöÑÊ¢ùÁõÆ',
            'base' => $ldapConfig['base_dn'],
            'filter' => '(|(uid=*ldap*)(cn=*ldap*)(description=*ldap*))',
            'description' => 'ÂåÖÂê´ ldap ÈóúÈçµÂ≠óÁöÑÊâÄÊúâÊ¢ùÁõÆ'
        ]
    ];
    
    foreach ($strategies as $strategy) {
        $scope = isset($strategy['scope']) ? $strategy['scope'] : 'sub';
        $result = exploreLDAPTree($connection, $strategy['base'], $strategy['filter'], $scope);
        $explorations[] = [
            'strategy' => $strategy,
            'result' => $result
        ];
    }
    
    ldap_unbind($connection);
}

function formatObjectClasses($objectClasses) {
    if (!is_array($objectClasses) || !isset($objectClasses['count'])) {
        return '';
    }
    
    $classes = [];
    for ($i = 0; $i < $objectClasses['count']; $i++) {
        $classes[] = $objectClasses[$i];
    }
    return implode(', ', $classes);
}

function isServiceAccount($item) {
    $description = strtolower($item['description']);
    $cn = strtolower($item['cn']);
    $uid = strtolower($item['uid']);
    
    $serviceKeywords = ['service', 'system', 'admin', 'ldap', 'bind', 'proxy'];
    
    foreach ($serviceKeywords as $keyword) {
        if (strpos($description, $keyword) !== false || 
            strpos($cn, $keyword) !== false || 
            strpos($uid, $keyword) !== false) {
            return true;
        }
    }
    
    return false;
}

function highlightLdapUser($text) {
    return str_ireplace('ldapuser', '<span class="highlight">ldapuser</span>', htmlspecialchars($text));
}
?>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDAP Ê®πÁãÄÁµêÊßãÂÆåÊï¥Êé¢Á¥¢Â∑•ÂÖ∑</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .service-account { background: #e7f3ff; border-color: #b6d7ff; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        th, td {
            padding: 6px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
            word-wrap: break-word;
            max-width: 200px;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #f8f9fa; }
        
        .dn-text {
            font-family: monospace;
            font-size: 0.75rem;
            color: #666;
            word-break: break-all;
        }
        
        .highlight {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .service-indicator {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .object-classes {
            font-size: 0.75rem;
            color: #666;
            max-width: 150px;
            word-break: break-word;
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible:before {
            content: "‚ñº ";
        }
        
        .collapsed:before {
            content: "‚ñ∂ ";
        }
        
        .content {
            display: block;
        }
        
        .content.hidden {
            display: none;
        }
        
        .summary-box {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå≥ LDAP Ê®πÁãÄÁµêÊßãÂÆåÊï¥Êé¢Á¥¢Â∑•ÂÖ∑</h1>
        <p>Ê∑±Â∫¶Êé¢Á¥¢ LDAP ÁµêÊßãÔºåÂåÖÂê´ÊúçÂãôÂ∏≥ËôüÂíåÁ≥ªÁµ±Â∏≥Ëôü</p>
        
        <div class="section info">
            <h3>üîå ÈÄ£Êé•ÁãÄÊÖã</h3>
            <p><strong>LDAP ‰º∫ÊúçÂô®Ôºö</strong> <?= $ldapConfig['server'] ?>:<?= $ldapConfig['port'] ?></p>
            <p><strong>ÈÄ£Êé•ÁãÄÊÖãÔºö</strong> <?= $connectionStatus ?></p>
            <p><strong>ÊúçÂãôÂ∏≥ËôüÔºö</strong> <?= $ldapConfig['admin_username'] ?></p>
        </div>

        <?php if ($connection): ?>
            <div class="summary-box">
                <h3>üìä Êé¢Á¥¢ÊëòË¶Å</h3>
                <?php 
                $totalItems = 0;
                $foundLdapUser = false;
                $serviceAccounts = 0;
                
                foreach ($explorations as $exploration) {
                    if ($exploration['result']['success']) {
                        $totalItems += $exploration['result']['count'];
                        foreach ($exploration['result']['results'] as $item) {
                            if (stripos($item['uid'], 'ldapuser') !== false || 
                                stripos($item['cn'], 'ldapuser') !== false) {
                                $foundLdapUser = true;
                            }
                            if (isServiceAccount($item)) {
                                $serviceAccounts++;
                            }
                        }
                    }
                }
                ?>
                <p><strong>Á∏ΩÂÖ±Êé¢Á¥¢È†ÖÁõÆÔºö</strong> <?= $totalItems ?></p>
                <p><strong>ÁôºÁèæ ldapuserÔºö</strong> <?= $foundLdapUser ? '‚úÖ ÊòØ' : '‚ùå Âê¶' ?></p>
                <p><strong>Áñë‰ººÊúçÂãôÂ∏≥ËôüÔºö</strong> <?= $serviceAccounts ?></p>
            </div>

            <?php foreach ($explorations as $exploration): ?>
                <div class="section <?= $exploration['result']['success'] ? 'success' : 'error' ?>">
                    <h3 class="collapsible" onclick="toggleContent(this)"><?= htmlspecialchars($exploration['strategy']['name']) ?></h3>
                    <div class="content">
                        <p><strong>ÊêúÂ∞ãÂü∫Á§éÔºö</strong> <code><?= htmlspecialchars($exploration['strategy']['base']) ?></code></p>
                        <p><strong>ÈÅéÊøæÂô®Ôºö</strong> <code><?= htmlspecialchars($exploration['strategy']['filter']) ?></code></p>
                        <p><strong>Ë™™ÊòéÔºö</strong> <?= htmlspecialchars($exploration['strategy']['description']) ?></p>
                        
                        <?php if ($exploration['result']['success']): ?>
                            <p><strong>ÁµêÊûúÔºö</strong> ‚úÖ ÊâæÂà∞ <?= $exploration['result']['count'] ?> ÂÄãÈ†ÖÁõÆ</p>
                            
                            <?php if ($exploration['result']['count'] > 0): ?>
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>UID</th>
                                                <th>CN</th>
                                                <th>ÈÉµ‰ª∂</th>
                                                <th>ÊèèËø∞</th>
                                                <th>Â∞çË±°È°ûÂà•</th>
                                                <th>DN</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach ($exploration['result']['results'] as $item): ?>
                                                <?php 
                                                $isService = isServiceAccount($item);
                                                $hasLdapUser = (stripos($item['uid'], 'ldapuser') !== false || 
                                                              stripos($item['cn'], 'ldapuser') !== false);
                                                $rowClass = $hasLdapUser ? 'style="background: #fff3cd; font-weight: bold;"' : 
                                                           ($isService ? 'style="background: #e7f3ff;"' : '');
                                                ?>
                                                <tr <?= $rowClass ?>>
                                                    <td>
                                                        <?= highlightLdapUser($item['uid']) ?>
                                                        <?= $isService ? '<span class="service-indicator">ÊúçÂãô</span>' : '' ?>
                                                    </td>
                                                    <td><?= highlightLdapUser($item['cn']) ?></td>
                                                    <td><?= htmlspecialchars($item['mail']) ?></td>
                                                    <td><?= highlightLdapUser($item['description']) ?></td>
                                                    <td class="object-classes"><?= formatObjectClasses($item['objectClass']) ?></td>
                                                    <td class="dn-text"><?= highlightLdapUser($item['dn']) ?></td>
                                                </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            <?php else: ?>
                                <p>üö´ Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÈ†ÖÁõÆ</p>
                            <?php endif; ?>
                        <?php else: ?>
                            <p><strong>ÈåØË™§Ôºö</strong> ‚ùå <?= htmlspecialchars($exploration['result']['message']) ?></p>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endforeach; ?>

        <?php else: ?>
            <div class="section error">
                <h3>‚ùå ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ LDAP ‰º∫ÊúçÂô®</h3>
                <p>Ë´ãÊ™¢Êü• LDAP ÈÖçÁΩÆÊàñÁ∂≤Ë∑ØÈÄ£Êé•</p>
            </div>
        <?php endif; ?>

        <div class="section warning">
            <h3>üîç ÂàÜÊûêÁµêÊûú</h3>
            <h4>Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ ldapuserÔºö</h4>
            <ul>
                <li><strong>ÂèØËÉΩÊÄß1Ôºö</strong> ldapuser Á¢∫ÂØ¶‰∏çÂ≠òÂú®Êñº LDAP ‰∏≠</li>
                <li><strong>ÂèØËÉΩÊÄß2Ôºö</strong> ldapuser Ë¢´Èö±ËóèÊàñÊúâÁâπÊÆäÁöÑÊü•ÁúãÊ¨äÈôê</li>
                <li><strong>ÂèØËÉΩÊÄß3Ôºö</strong> ldapuser Âú®ÈÖçÁΩÆ‰∏≠Âè™ÊòØÁØÑ‰æãÔºåÂØ¶Èöõ‰∏çÂ≠òÂú®</li>
                <li><strong>ÂèØËÉΩÊÄß4Ôºö</strong> ldapuser Âú®ÂÖ∂‰ªñÊàëÂÄëÊ≤íÊúâÊ¨äÈôêÊü•ÁúãÁöÑOU‰∏≠</li>
            </ul>
            
            <h4>Âª∫Ë≠∞ÁöÑËß£Ê±∫ÊñπÊ°àÔºö</h4>
            <ul>
                <li>‰ΩøÁî®‰∏äÈù¢ÊâæÂà∞ÁöÑÂÖ∂‰ªñÁúüÂØ¶Â∏≥ËôüÈÄ≤Ë°å LDAP ÁôªÂÖ•Ê∏¨Ë©¶</li>
                <li>ËÅØÁπ´ LDAP ÁÆ°ÁêÜÂì°Á¢∫Ë™ç ldapuser ÁöÑÂØ¶ÈöõÁãÄÊÖã</li>
                <li>Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÊúçÂãôÂ∏≥ËôüÂèØ‰ª•Áî®ÊñºÈÖçÁΩÆ</li>
                <li>Á¢∫Ë™çÁï∂ÂâçÊúçÂãôÂ∏≥ËôüÁöÑÊü•ÁúãÊ¨äÈôêÁØÑÂúç</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="find_ldapuser.php"><button style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">üéØ Â∞àÈñÄÊêúÂ∞ãÂ∑•ÂÖ∑</button></a>
            <a href="ldap_debug.php"><button style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">üß™ Ë™çË≠âÊ∏¨Ë©¶</button></a>
            <a href="login"><button style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">üîê ÁôªÂÖ•È†ÅÈù¢</button></a>
        </div>
    </div>

    <script>
        function toggleContent(element) {
            const content = element.nextElementSibling;
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                element.classList.remove('collapsed');
            } else {
                content.classList.add('hidden');
                element.classList.add('collapsed');
            }
        }
    </script>
</body>
</html> 